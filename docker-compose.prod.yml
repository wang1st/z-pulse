# 生产环境 Docker Compose 配置
# 使用预构建的镜像，而不是在服务器上构建
# 适用于低配置服务器或需要快速部署的场景

services:
  # 1. 数据中心：PostgreSQL 数据库
  postgres-db:
    image: postgres:15-alpine
    container_name: zpulse-db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./shared/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal-net
    restart: unless-stopped

  # 2. 神经中枢：FastAPI 后端（使用预构建镜像）
  api-backend:
    container_name: zpulse-api
    image: zpulse-backend:latest
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "127.0.0.1:8000:8000"
    depends_on:
      postgres-db:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres-db/${POSTGRES_DB}
      - POSTGRES_HOST=postgres-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-brevo}
      - BREVO_API_KEY=${BREVO_API_KEY}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM}
      - WEB_URL=${WEB_URL:-http://localhost:3000}
      - WERSS_ADMIN_USERNAME=${WERSS_ADMIN_USERNAME:-admin}
      - WERSS_ADMIN_PASSWORD=${WERSS_ADMIN_PASSWORD:-admin@123}
      - USE_WERSS_DB=True
      - WERSS_DB_PATH=/app/werss_data/werss.db
      - WERSS_DB_LIMIT=400
      - MIN_ARTICLE_DATE=${MIN_ARTICLE_DATE:-2025-12-15}
    volumes:
      - ./backend:/app/backend
      - ./shared:/app/shared
      - rss_bridge_data:/app/werss_data
    networks:
      - internal-net
      - proxy-net
    restart: unless-stopped

  # 3. 用户界面：Next.js 前端（使用预构建镜像）
  frontend-web:
    container_name: zpulse-web
    image: zpulse-frontend:latest
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      api-backend:
        condition: service_started
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://api-backend:8000}
      - NODE_ENV=production
    networks:
      - proxy-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 4. 采集器：微信转RSS桥接器 (we-mp-rss)
  rss-bridge:
    image: rachelos/we-mp-rss:latest
    container_name: zpulse-rss
    working_dir: /app
    shm_size: "1gb"
    ports:
      - "8080:8001"
      - "3001:8001"
    volumes:
      - rss_bridge_data:/app/data
      - ./werss_overrides/apis/auth.py:/app/apis/auth.py:ro
    environment:
      - TZ=Asia/Shanghai
      - APP_NAME=ZPulse RSS Bridge
      - WEB_NAME=财政公众号采集助手
      - PORT=8001
      - WEB_PORT=3000
      - ENABLE_WEB=True
      - ENABLE_JOB=True
      - WERSS_AUTH_WEB=True
      - PLAYWRIGHT_BROWSERS_PATH=/app/data/driver/_x86_64
      - BROWSER_TYPE=chromium-headless-shell
      - THREADS=1
      - SPAN_INTERVAL=8
      - DB=sqlite:///data/werss.db
      - RSS_BASE_URL=${RSS_BASE_URL:-http://localhost:8080}
      - RSS_FULL_CONTEXT=True
      - GATHER.CONTENT=True
      - GATHER.CONTENT_MODE=web
      - GATHER.CLEAN_HTML=True
      - GATHER.CONTENT_AUTO_CHECK=False
      - GATHER.CONTENT_AUTO_INTERVAL=1440
      - MAX_PAGE=10
      - RSS_PAGE_SIZE=50
      - SECRET_KEY=${WERSS_SECRET_KEY:-zpulse-rss}
    networks:
      - internal-net
    restart: unless-stopped

  # 5. 投喂器：RSS采集工作节点（使用预构建镜像）
  ingestion-worker:
    container_name: zpulse-ingest-worker
    image: zpulse-backend:latest
    command: python -m app.workers.ingest
    depends_on:
      postgres-db:
        condition: service_healthy
      rss-bridge:
        condition: service_started
    environment:
      - TZ=Asia/Shanghai
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres-db/${POSTGRES_DB}
      - POSTGRES_HOST=postgres-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - RSS_BRIDGE_URL=http://rss-bridge:8001
      - POLL_INTERVAL=1800
      - INGEST_OFFSET_MINUTES=5
      - INGEST_RUN_AT=21:00
      - USE_WERSS_DB=True
      - WERSS_DB_PATH=/app/werss_data/werss.db
      - WERSS_DB_LIMIT=400
      - FETCH_FULL_CONTENT=True
      - WERSS_ADMIN_USERNAME=${WERSS_ADMIN_USERNAME:-admin}
      - WERSS_ADMIN_PASSWORD=${WERSS_ADMIN_PASSWORD:-admin@123}
      - FULLTEXT_TIMEOUT=80
      - FULLTEXT_MAX_RETRIES=4
      - FULLTEXT_RETRY_BASE_SLEEP=2
      - FULLTEXT_MIN_INTERVAL=2
      - MIN_ARTICLE_DATE=${MIN_ARTICLE_DATE:-2025-12-15}
    volumes:
      - ./backend:/app/backend
      - ./shared:/app/shared
      - rss_bridge_data:/app/werss_data
    networks:
      - internal-net
    restart: unless-stopped

  # 6. 分析师：AI报告生成工作节点（使用预构建镜像）
  ai-worker:
    container_name: zpulse-ai-worker
    image: zpulse-backend:latest
    command: python -m app.workers.ai_generate
    depends_on:
      postgres-db:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres-db/${POSTGRES_DB}
      - POSTGRES_HOST=postgres-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-brevo}
      - BREVO_API_KEY=${BREVO_API_KEY}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-这里财动}
      - WEB_URL=${WEB_URL:-http://localhost:3000}
      - QWEN_DAILY_MODEL=${QWEN_DAILY_MODEL:-qwen-plus}
      - QWEN_FILTER_MODEL=${QWEN_FILTER_MODEL:-qwen-flash}
      - QWEN_WEEKLY_MODEL=${QWEN_WEEKLY_MODEL:-qwen-max-latest}
      - DAILY_REPORT_TIME=09:45
      - WEEKLY_REPORT_DAY=${WEEKLY_REPORT_DAY:-sunday}
      - WEEKLY_REPORT_TIME=${WEEKLY_REPORT_TIME:-22:00}
      - SENTENCE_TRANSFORMERS_HOME=/app/models_cache
      - HF_HOME=/app/models_cache
    volumes:
      - ./backend:/app/backend
      - ./shared:/app/shared
      - bertopic_models_cache:/app/models_cache
    networks:
      - internal-net
    restart: unless-stopped

  # Redis (缓存和会话)
  redis:
    image: redis:7-alpine
    container_name: zpulse-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal-net
    restart: unless-stopped

  # 7. 网关：反向代理 (Nginx)
  reverse-proxy:
    image: nginx:latest
    container_name: zpulse-proxy
    ports:
      - "127.0.0.1:80:80"
      - "127.0.0.1:443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - frontend-web
      - api-backend
    networks:
      - proxy-net
    restart: unless-stopped

volumes:
  postgres_data:
  rss_bridge_data:
  redis_data:
  bertopic_models_cache:

networks:
  proxy-net:
    driver: bridge
  internal-net:
    driver: bridge

